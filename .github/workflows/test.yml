name: Python package

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Tests (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.13', '3.14']
        include:
          # Free-threaded Python (GIL disabled) - test on all platforms
          - os: ubuntu-latest
            python-version: '3.14t'
          - os: macos-latest
            python-version: '3.14t'
          - os: windows-latest
            python-version: '3.14t'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e . pytest

      - name: Check GIL status
        run: |
          uv run python -c "
          import sys
          print(f'Python: {sys.version}')
          if hasattr(sys, '_is_gil_enabled'):
              print(f'GIL disabled: {not sys._is_gil_enabled()}')
          else:
              print('GIL status: N/A (Python < 3.13)')
          "

      - name: Run tests
        run: |
          uv run pytest tests/ -v

  test-free-threaded-concurrent:
    name: Concurrent Tests (Free-threaded Python)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13t', '3.14t']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e . pytest

      - name: Verify GIL is disabled
        run: |
          uv run python -c "
          import sys
          if hasattr(sys, '_is_gil_enabled'):
              gil_enabled = sys._is_gil_enabled()
              print(f'GIL enabled: {gil_enabled}')
              if gil_enabled:
                  print('WARNING: Expected GIL to be disabled for free-threaded build')
                  sys.exit(1)
              print('âœ“ Running on free-threaded Python with GIL disabled')
          else:
              print('WARNING: sys._is_gil_enabled not available')
              sys.exit(1)
          "

      - name: Run all tests including thread-safety tests
        run: |
          uv run pytest tests/ -v --tb=short
